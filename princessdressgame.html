<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Princess Barbie Makeover</title>
  <style>
    body {
      font-family: 'Comic Sans MS', cursive;
      background: #ffe6f0;
      margin: 0;
      overflow-x: hidden;
    }

    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    #barbie-area {
      position: relative;
      width: 300px;
      height: 500px;
      background: url('https://i.ibb.co/QFBNvd7/bg1.jpg') no-repeat center/cover;
      border: 5px solid #ff99cc;
      border-radius: 20px;
      overflow: hidden;
      touch-action: none;
    }

    #barbie-img {
      width: 100%;
      position: absolute;
      bottom: 0;
      z-index: 1;
    }

    .item {
      position: absolute;
      z-index: 2;
      max-width: 100%;
      touch-action: none;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
      gap: 10px;
    }

    .control-section {
      background: #fff0ff;
      padding: 10px;
      border-radius: 12px;
    }

    .control-section h4 {
      margin: 0 0 5px 0;
    }

    button {
      margin: 3px;
      padding: 6px 10px;
      border: none;
      background: #ffc0cb;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #ff88aa;
    }

    input[type="color"] {
      margin: 3px;
    }

    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="barbie-area">
      <img id="barbie-img" src="https://i.ibb.co/VxHbGbG/barbie-base.png" alt="Barbie">
    </div>

    <div id="controls">
      <div class="control-section">
        <h4>Dresses</h4>
        <button onclick="addItem('https://i.ibb.co/yydYMGp/dress1.png')">One-piece</button>
        <button onclick="addItem('https://i.ibb.co/N3rLXL1/dress2.png')">Two-piece</button>
      </div>

      <div class="control-section">
        <h4>Hair</h4>
        <button onclick="addItem('https://i.ibb.co/f2F5F6k/hair1.png')">Style 1</button>
        <button onclick="addItem('https://i.ibb.co/Br5Twv7/hair2.png')">Style 2</button>
      </div>

      <div class="control-section">
        <h4>Accessories</h4>
        <button onclick="addItem('https://i.ibb.co/3dHdX2V/hat.png')">Hat</button>
        <button onclick="addItem('https://i.ibb.co/WxvvBqF/glasses.png')">Sunglasses</button>
        <button onclick="addItem('https://i.ibb.co/86z5vsX/bag.png')">Handbag</button>
      </div>

      <div class="control-section">
        <h4>Makeup</h4>
        <label>Eyeshadow</label><input type="color" onchange="addMakeup('eyeshadow', this.value)"><br>
        <label>Lipstick</label><input type="color" onchange="addMakeup('lipstick', this.value)"><br>
        <label>Blush</label><input type="color" onchange="addMakeup('blush', this.value)">
      </div>

      <div class="control-section">
        <h4>Background</h4>
        <button onclick="changeBackground('https://i.ibb.co/QFBNvd7/bg1.jpg')">Garden</button>
        <button onclick="changeBackground('https://i.ibb.co/FsxX3pN/bg2.jpg')">Palace</button>
      </div>

      <div class="control-section">
        <h4>Actions</h4>
        <button onclick="undo()">Undo</button>
        <button onclick="reset()">Reset</button>
        <button onclick="saveImage()">Save</button>
      </div>
    </div>
  </div>

  <canvas id="canvas" width="300" height="500"></canvas>

  <script>
    const barbieArea = document.getElementById('barbie-area');
    const historyStack = [];

    function addItem(src) {
      const img = document.createElement('img');
      img.src = src;
      img.className = 'item';
      img.style.left = '100px';
      img.style.top = '100px';
      enableDrag(img);
      barbieArea.appendChild(img);
      historyStack.push(img);
    }

    function addMakeup(type, color) {
      const circle = document.createElement('div');
      circle.className = 'item';
      circle.style.width = '60px';
      circle.style.height = '60px';
      circle.style.background = color;
      circle.style.borderRadius = '50%';
      circle.style.opacity = '0.4';
      circle.style.left = '120px';
      circle.style.top = type === 'blush' ? '180px' : type === 'eyeshadow' ? '100px' : '200px';
      enableDrag(circle);
      barbieArea.appendChild(circle);
      historyStack.push(circle);
    }

    function changeBackground(url) {
      barbieArea.style.background = `url('${url}') no-repeat center/cover`;
    }

    function undo() {
      const last = historyStack.pop();
      if (last) last.remove();
    }

    function reset() {
      historyStack.forEach(item => item.remove());
      historyStack.length = 0;
    }

    function saveImage() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const imgs = Array.from(barbieArea.querySelectorAll('img, .item'));

      const loadImages = imgs.map(el => {
        return new Promise(resolve => {
          if (el.tagName === 'IMG') {
            const tempImg = new Image();
            tempImg.crossOrigin = "anonymous";
            tempImg.src = el.src;
            tempImg.onload = () => resolve({ img: tempImg, x: el.offsetLeft, y: el.offsetTop, w: el.width, h: el.height });
          } else {
            // for makeup circles
            resolve(null);
          }
        });
      });

      Promise.all(loadImages).then(images => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        images.forEach(data => {
          if (data) ctx.drawImage(data.img, data.x, data.y, data.w, data.h);
        });
        const link = document.createElement('a');
        link.download = 'princess-look.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function enableDrag(el) {
      let offsetX, offsetY;

      el.addEventListener('mousedown', startDrag);
      el.addEventListener('touchstart', startDrag);

      function startDrag(e) {
        e.preventDefault();
        const evt = e.type === 'touchstart' ? e.touches[0] : e;
        offsetX = evt.clientX - el.offsetLeft;
        offsetY = evt.clientY - el.offsetTop;

        window.addEventListener('mousemove', drag);
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('touchmove', drag, { passive: false });
        window.addEventListener('touchend', stopDrag);
      }

      function drag(e) {
        const evt = e.type === 'touchmove' ? e.touches[0] : e;
        el.style.left = `${evt.clientX - offsetX}px`;
        el.style.top = `${evt.clientY - offsetY}px`;
      }

      function stopDrag() {
        window.removeEventListener('mousemove', drag);
        window.removeEventListener('mouseup', stopDrag);
        window.removeEventListener('touchmove', drag);
        window.removeEventListener('touchend', stopDrag);
      }
    }
  </script>
</body>
</html>
